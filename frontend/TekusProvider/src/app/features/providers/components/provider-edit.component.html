<div class="provider-edit-container">
  <mat-card class="edit-card">
    <mat-card-header>
      <mat-card-title class="header-title">
        <mat-icon>edit</mat-icon>
        <span>Editar Proveedor</span>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (isLoading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Cargando información del proveedor...</p>
        </div>
      } @else if (errorMessage() && !provider()) {
        <div class="error-container">
          <mat-icon class="error-icon">error</mat-icon>
          <p class="error-message">{{ errorMessage() }}</p>
          <button mat-raised-button color="primary" (click)="onCancel()">
            Volver al listado
          </button>
        </div>
      } @else {
        <form [formGroup]="providerForm" (ngSubmit)="onSubmit()" class="provider-form">
          @if (provider()) {
            <div class="info-section">
              <p class="info-label">ID del Proveedor:</p>
              <p class="info-value">{{ provider()!.id }}</p>
            </div>
          }

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>NIT</mat-label>
            <input
              matInput
              formControlName="nit"
              placeholder="Ingrese el NIT"
              [class.disabled]="isSaving()"
            />
            <mat-icon matPrefix>badge</mat-icon>
            @if (providerForm.get('nit')?.invalid && providerForm.get('nit')?.touched) {
              <mat-error>{{ getErrorMessage('nit') }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Ingrese el nombre del proveedor"
              [class.disabled]="isSaving()"
            />
            <mat-icon matPrefix>business</mat-icon>
            @if (providerForm.get('name')?.invalid && providerForm.get('name')?.touched) {
              <mat-error>{{ getErrorMessage('name') }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input
              matInput
              type="email"
              formControlName="email"
              placeholder="Ingrese el email"
              [class.disabled]="isSaving()"
            />
            <mat-icon matPrefix>email</mat-icon>
            @if (providerForm.get('email')?.invalid && providerForm.get('email')?.touched) {
              <mat-error>{{ getErrorMessage('email') }}</mat-error>
            }
          </mat-form-field>

          @if (errorMessage()) {
            <div class="form-error">
              <mat-icon>warning</mat-icon>
              <span>{{ errorMessage() }}</span>
            </div>
          }

          <!-- Campos Personalizados -->
          <mat-divider class="section-divider"></mat-divider>
          
          <mat-expansion-panel class="custom-fields-panel" [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>tune</mat-icon>
                <span>Campos Personalizados</span>
              </mat-panel-title>
              <mat-panel-description>
                {{ customFields.length }} campo(s) adicional(es)
              </mat-panel-description>
            </mat-expansion-panel-header>

            @if (customFields.length > 0) {

              <div class="custom-fields-container" formArrayName="customFields">
                @for (field of customFields.controls; track $index) {
                  <div class="custom-field-wrapper">
                    <div class="custom-field-item" [formGroupName]="$index">
                      @switch (field.get('fieldType')?.value) {
                      @case ('text') {
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>{{ field.get('fieldName')?.value }}</mat-label>
                          <input
                            matInput
                            formControlName="fieldValue"
                            [placeholder]="field.get('description')?.value"
                            [class.disabled]="isSaving()"
                          />
                          <mat-icon matPrefix>{{ getFieldIcon('text') }}</mat-icon>
                          <mat-hint>{{ field.get('description')?.value }}</mat-hint>
                        </mat-form-field>
                      }
                      @case ('url') {
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>{{ field.get('fieldName')?.value }}</mat-label>
                          <input
                            matInput
                            type="url"
                            formControlName="fieldValue"
                            [placeholder]="field.get('description')?.value"
                            [class.disabled]="isSaving()"
                          />
                          <mat-icon matPrefix>{{ getFieldIcon('url') }}</mat-icon>
                          <mat-hint>{{ field.get('description')?.value }}</mat-hint>
                        </mat-form-field>
                      }
                      @case ('date') {
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>{{ field.get('fieldName')?.value }}</mat-label>
                          <input
                            matInput
                            [matDatepicker]="picker"
                            formControlName="fieldValue"
                            [placeholder]="field.get('description')?.value"
                            [class.disabled]="isSaving()"
                          />
                          <mat-icon matPrefix>{{ getFieldIcon('date') }}</mat-icon>
                          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                          <mat-datepicker #picker></mat-datepicker>
                          <mat-hint>{{ field.get('description')?.value }}</mat-hint>
                        </mat-form-field>
                      }
                      @case ('boolean') {
                        <div class="boolean-field">
                          <mat-slide-toggle
                            formControlName="fieldValue"
                            color="primary"
                            [disabled]="isSaving()"
                          >
                            <div class="boolean-field-content">
                              <mat-icon>{{ getFieldIcon('boolean') }}</mat-icon>
                              <div class="boolean-field-text">
                                <span class="boolean-field-label">{{ field.get('fieldName')?.value }}</span>
                                <span class="boolean-field-description">{{ field.get('description')?.value }}</span>
                              </div>
                            </div>
                          </mat-slide-toggle>
                        </div>
                      }
                      @case ('number') {
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>{{ field.get('fieldName')?.value }}</mat-label>
                          <input
                            matInput
                            type="number"
                            formControlName="fieldValue"
                            [placeholder]="field.get('description')?.value"
                            [class.disabled]="isSaving()"
                          />
                          <mat-icon matPrefix>{{ getFieldIcon('number') }}</mat-icon>
                          <mat-hint>{{ field.get('description')?.value }}</mat-hint>
                        </mat-form-field>
                        }
                      }
                    </div>
                    <div class="field-actions">
                      <button
                        mat-icon-button
                        color="primary"
                        type="button"
                        (click)="openEditCustomFieldDialog($index)"
                        matTooltip="Editar campo"
                        [disabled]="isSaving()"
                      >
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        color="warn"
                        type="button"
                        (click)="deleteCustomField($index)"
                        matTooltip="Eliminar campo"
                        [disabled]="isSaving()"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="no-custom-fields">
                <mat-icon>info</mat-icon>
                <p>No hay campos personalizados configurados</p>
              </div>
            }

            <div class="panel-actions">
              <button
                mat-raised-button
                color="accent"
                type="button"
                (click)="openCreateCustomFieldDialog()"
                [disabled]="isSaving()"
              >
                <mat-icon>add</mat-icon>
                Agregar Campo Personalizado
              </button>
            </div>
          </mat-expansion-panel>

          <!-- Servicios Asociados -->
          @if (provider() && provider()!.services.length > 0) {
            <mat-divider class="section-divider"></mat-divider>
            
            <mat-expansion-panel class="services-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>room_service</mat-icon>
                  <span>Servicios Asociados</span>
                </mat-panel-title>
                <mat-panel-description>
                  {{ provider()!.services.length }} servicio(s) registrado(s)
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="services-list">
                @for (service of provider()!.services; track service.id) {
                  <div class="service-item">
                    <div class="service-header">
                      <mat-icon color="primary">check_circle</mat-icon>
                      <h4>{{ service.name }}</h4>
                    </div>
                    <p class="service-description">{{ service.description }}</p>
                    <div class="service-details">
                      <span class="service-rate">
                        <mat-icon>attach_money</mat-icon>
                        ${{ service.hourlyRate }}/hora
                      </span>
                      <span class="service-date">
                        Creado: {{ service.createdAt | date: 'dd/MM/yyyy' }}
                      </span>
                    </div>
                  </div>
                }
              </div>
            </mat-expansion-panel>
          }

          @if (provider()) {
            <mat-divider class="section-divider"></mat-divider>
            <div class="metadata-section">
              <p class="metadata-item">
                <strong>Creado:</strong> {{ provider()!.createdAt | date: 'dd/MM/yyyy HH:mm' }}
                por {{ provider()!.createdBy }}
              </p>
              @if (provider()!.updatedAt) {
                <p class="metadata-item">
                  <strong>Última actualización:</strong> {{ provider()!.updatedAt | date: 'dd/MM/yyyy HH:mm' }}
                  por {{ provider()!.updatedBy }}
                </p>
              }
            </div>
          }

          <div class="form-actions">
            <button
              mat-raised-button
              type="button"
              (click)="onCancel()"
              [disabled]="isSaving()"
            >
              <mat-icon>close</mat-icon>
              Cancelar
            </button>
            @if (isSaving()) {
              <button
                mat-raised-button
                color="primary"
                type="submit"
                disabled
              >
                <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                <span>Guardando...</span>
              </button>
            } @else {
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="providerForm.invalid"
              >
                <mat-icon>save</mat-icon>
                <span>Guardar Cambios</span>
              </button>
            }
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>

